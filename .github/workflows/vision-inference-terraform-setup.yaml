name: Vision Inference - Terraform Setup

# âš ï¸ MANUAL TRIGGER ONLY - This workflow must be run manually from GitHub Actions UI
# It provisions infrastructure using Terraform and should be run:
#   1. First time setup (action=apply)
#   2. Infrastructure changes (action=plan then apply)
#   3. Infrastructure teardown (action=destroy)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      auto_approve:
        description: 'Auto-approve apply/destroy (use with caution)'
        required: false
        default: false
        type: boolean

  # Automatic trigger disabled - run manually only via GitHub Actions UI
  # push:
  #   branches: [main]
  #   paths:
  #     - "deploymentVisionInference/terraform/**"
  #     - ".github/workflows/vision-inference-terraform-setup.yaml"

jobs:
  terraform:
    runs-on: ubuntu-latest
    
    env:
      PROJECT_ID: medscanai-476500
      REGION: us-central1
      TF_VAR_project_id: medscanai-476500
      TF_VAR_region: us-central1
      TERRAFORM_VERSION: 1.6.0

    defaults:
      run:
        working-directory: deploymentVisionInference/terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Check API Enablement Status
        run: |
          echo "Checking if required APIs are enabled..."
          echo ""
          echo "Note: If APIs are not enabled, you may need to:"
          echo "  1. Enable them manually in GCP Console, OR"
          echo "  2. Grant 'roles/serviceusage.serviceUsageAdmin' to your service account"
          echo ""
          echo "Required APIs:"
          echo "  - run.googleapis.com"
          echo "  - artifactregistry.googleapis.com"
          echo "  - cloudbuild.googleapis.com"
          echo "  - storage-api.googleapis.com"
          echo ""
          echo "Terraform will skip API enablement by default (enable_apis=false)"
          echo "If you need to enable APIs, set enable_apis=true in terraform.tfvars"
        continue-on-error: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: |
          echo "Checking Terraform file formatting..."
          if ! terraform fmt -check -recursive; then
            echo "âš ï¸  Warning: Some Terraform files need formatting"
            echo "Run 'terraform fmt -recursive' locally to fix"
            echo "Continuing with workflow..."
          else
            echo "âœ… All Terraform files are properly formatted"
          fi
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: |
          echo "Initializing Terraform..."
          terraform init

      - name: Auto-Import Existing Resources
        if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'apply' || github.event.inputs.action == 'plan')
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Checking for existing resources to import..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Check if Cloud Run service exists
          if gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(metadata.name)" 2>/dev/null | grep -q "${{ env.SERVICE_NAME }}"; then
            
            echo "âœ… Found existing Cloud Run service: ${{ env.SERVICE_NAME }}"
            echo "Importing into Terraform state..."
            
            terraform import google_cloud_run_service.vision_inference_api \
              "locations/${{ env.REGION }}/namespaces/${{ env.PROJECT_ID }}/services/${{ env.SERVICE_NAME }}" 2>/dev/null && \
              echo "âœ… Cloud Run service imported successfully" || \
              echo "âš ï¸  Service may already be in state or import failed (continuing...)"
          else
            echo "â„¹ï¸  Cloud Run service does not exist (will be created)"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true

      - name: Terraform Validate
        id: validate
        run: |
          echo "Validating Terraform configuration..."
          terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          echo "Creating Terraform execution plan..."
          terraform plan -no-color -out=tfplan
        continue-on-error: false

      - name: Show Terraform Plan
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Terraform Plan Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          terraform show tfplan

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const output = `#### Terraform Format and Style ğŸ–Œ\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`
            #### Terraform Validation ğŸ¤–\`${{ steps.validate.outcome }}\`
            #### Terraform Plan ğŸ“–\`${{ steps.plan.outcome }}\`
            
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`
            
            </details>
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Terraform Apply
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        run: |
          echo "Applying Terraform configuration..."
          
          if [ "${{ github.event.inputs.auto_approve }}" = "true" ]; then
            terraform apply -auto-approve tfplan
          else
            echo "âš ï¸ Manual approval required. Set auto_approve=true to apply automatically."
            echo "Or run: terraform apply in the terraform directory"
            exit 1
          fi

      - name: Preview Destroy (What will be deleted)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  DESTROY ACTION - VISION INFERENCE RESOURCES ONLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "The following Vision Inference resources will be DELETED:"
          echo ""
          echo "  âŒ Cloud Run Service: vision-inference-api"
          echo "     â””â”€ Service will be permanently deleted"
          echo "     â””â”€ All revisions will be removed"
          echo ""
          echo "  âŒ Artifact Registry Repository: vision-inference"
          echo "     â””â”€ Docker image repository will be deleted"
          echo "     â””â”€ All stored Docker images will be removed"
          echo ""
          echo "  âŒ IAM Bindings for Cloud Build Service Account:"
          echo "     â””â”€ roles/run.admin (Cloud Run management)"
          echo "     â””â”€ roles/iam.serviceAccountUser (Service account usage)"
          echo "     â””â”€ roles/storage.objectViewer (GCS read access)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… RESOURCES THAT WILL NOT BE AFFECTED:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "  âœ“ GCS Bucket: medscan-pipeline-medscanai-476500"
          echo "  âœ“ Trained Models in GCS"
          echo "  âœ“ Other Cloud Run services (e.g., rag-service)"
          echo "  âœ“ Other Artifact Registry repositories"
          echo "  âœ“ Cloud Build service account"
          echo "  âœ“ Any other GCP resources not managed by this Terraform"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Show actual plan
          terraform plan -destroy -no-color
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Terraform Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
        run: |
          echo "ğŸ—‘ï¸  Destroying Vision Inference infrastructure..."
          echo ""
          
          if [ "${{ github.event.inputs.auto_approve }}" = "true" ]; then
            echo "âš ï¸  Auto-approve enabled. Running cleanup script..."
            echo ""
            
            # Make script executable
            chmod +x cleanup_resources.sh
            
            # Run cleanup script (handles both Terraform and manual resources)
            if ./cleanup_resources.sh; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… Vision Inference resources destroyed successfully"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
              echo "To recreate infrastructure, run this workflow with action=apply"
            else
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âš ï¸  Cleanup completed with warnings"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
              echo "Check the logs above for details."
              echo "You may need to manually verify resource deletion in GCP Console."
            fi
          else
            echo "âš ï¸ Manual approval required for destroy."
            echo ""
            echo "To proceed with destroy:"
            echo "  Option 1: Re-run workflow with auto_approve=true"
            echo "  Option 2: Run manually in terminal:"
            echo "    cd deploymentVisionInference/terraform"
            echo "    chmod +x cleanup_resources.sh"
            echo "    ./cleanup_resources.sh"
            echo ""
            exit 1
          fi

      - name: Get Terraform Outputs
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        id: outputs
        run: |
          echo "Fetching Terraform outputs..."
          
          SERVICE_URL=$(terraform output -raw service_url 2>/dev/null || echo "Not available")
          HEALTH_ENDPOINT=$(terraform output -raw health_endpoint 2>/dev/null || echo "Not available")
          API_DOCS=$(terraform output -raw api_docs_endpoint 2>/dev/null || echo "Not available")
          
          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "health_endpoint=${HEALTH_ENDPOINT}" >> $GITHUB_OUTPUT
          echo "api_docs=${API_DOCS}" >> $GITHUB_OUTPUT

      - name: Test Deployed Infrastructure
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        run: |
          SERVICE_URL="${{ steps.outputs.outputs.service_url }}"
          
          if [ "$SERVICE_URL" != "Not available" ] && [ ! -z "$SERVICE_URL" ]; then
            echo "Testing deployed service..."
            
            # Wait a bit for service to be ready
            sleep 10
            
            # Test health endpoint
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/health" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Service is accessible and healthy!"
            else
              echo "âš ï¸ Service returned status: ${HTTP_CODE}"
              echo "Note: Service may still be deploying. Check Cloud Run console."
            fi
          else
            echo "âš ï¸ Service URL not available yet. Infrastructure created but service may not be deployed."
            echo "Run the vision-inference-deploy.yaml workflow to deploy the application."
          fi

      - name: Infrastructure Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Terraform ${{ github.event.inputs.action || 'plan' }} Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Terraform Outputs:"
          terraform output
          echo ""
          echo "ğŸ”— Useful Links:"
          echo "  â€¢ Cloud Run Console: https://console.cloud.google.com/run?project=${{ env.PROJECT_ID }}"
          echo "  â€¢ Artifact Registry: https://console.cloud.google.com/artifacts?project=${{ env.PROJECT_ID }}"
          echo "  â€¢ Cloud Build: https://console.cloud.google.com/cloud-build?project=${{ env.PROJECT_ID }}"
          echo ""
          
          if [ "${{ github.event.inputs.action }}" = "apply" ]; then
            echo "ğŸš€ Next Steps:"
            echo "  1. Deploy the application using: vision-inference-deploy.yaml workflow"
            echo "  2. Or manually run: gcloud builds submit --config=ModelDevelopment/VisionInference/cloudbuild.yaml"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Upload Terraform Plan
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: deploymentVisionInference/terraform/tfplan
          retention-days: 7

      - name: Save Terraform State Info
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        run: |
          mkdir -p ../../../terraform-state-info
          
          cat > ../../../terraform-state-info/infrastructure-state.json <<EOF
          {
            "project_id": "${{ env.PROJECT_ID }}",
            "region": "${{ env.REGION }}",
            "service_url": "${{ steps.outputs.outputs.service_url }}",
            "health_endpoint": "${{ steps.outputs.outputs.health_endpoint }}",
            "api_docs": "${{ steps.outputs.outputs.api_docs }}",
            "applied_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "applied_by": "${{ github.actor }}",
            "commit_sha": "${{ github.sha }}"
          }
          EOF
          
          cat ../../../terraform-state-info/infrastructure-state.json

      - name: Upload Infrastructure State
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-state-info
          path: terraform-state-info/infrastructure-state.json
          retention-days: 90

      - name: Cleanup on Failure
        if: failure()
        run: |
          echo "âš ï¸ Workflow failed. Terraform state may be inconsistent."
          echo "Check the logs above for errors."
          echo ""
          echo "To fix manually:"
          echo "  1. cd deploymentVisionInference/terraform"
          echo "  2. terraform init"
          echo "  3. terraform plan"
          echo "  4. Review and fix issues"
          echo ""
          echo "For Terraform state issues:"
          echo "  â€¢ View state: terraform show"
          echo "  â€¢ List resources: terraform state list"
          echo "  â€¢ Remove stuck resource: terraform state rm <resource>"
