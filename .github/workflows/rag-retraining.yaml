name: RAG Model Selection

on:
  workflow_run:
    workflows: ["RAG Data Pipeline"]
    types: [completed]
    branches: [main]
  
  workflow_dispatch:
    inputs:
      triggered_by:
        description: 'Triggered by'
        default: 'manual'
      reason:
        description: 'Reason'
        default: 'Manual'
      use_existing_data:
        description: 'Use existing data (true for Scenario 1)'
        type: boolean
        default: false

jobs:
  select-model:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    steps:
      - uses: actions/checkout@v3
      - uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: medscanai-476500
      
      - name: Verify data
        run: |
          gsutil ls gs://medscan-pipeline-medscanai-476500/RAG/index/index_latest.bin || exit 1
          gsutil ls gs://medscan-pipeline-medscanai-476500/RAG/index/embeddings_latest.json || exit 1
      
      - name: Submit Cloud Build
        id: build
        run: |
          BUILD_ID=$(gcloud builds submit . \
            --config=cloudbuild/rag-training.yaml \
            --region=us-central1 \
            --format="value(id)")
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
      
      - name: Stream logs
        run: |
          gcloud builds log ${{ steps.build.outputs.build_id }} \
            --stream --region=us-central1
      
      - name: Send notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: RAG Model Selection - ${{ job.status }}
          to: harshitha8.shekar@gmail.com,kothari.sau@northeastern.edu
          from: MedScan AI <${{ secrets.SMTP_USER }}>
          body: |
            Model Selection: ${{ job.status }}
            Triggered by: ${{ github.event.inputs.triggered_by || 'data pipeline' }}
            
            Build: https://console.cloud.google.com/cloud-build/builds/${{ steps.build.outputs.build_id }}