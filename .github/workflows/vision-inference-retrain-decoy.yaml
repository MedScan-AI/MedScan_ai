name: Vision Inference Retraining Threshold Monitor

on:
  schedule:
    # Run every 1 minute (for testing - change back to '0 9 * * *' for daily)
    - cron: '* * * * *'
  
  workflow_dispatch:
    inputs:
      threshold:
        description: 'Low confidence threshold count (default: 50)'
        type: number
        default: 5
      hours_lookback:
        description: 'Hours to look back (default: 24)'
        type: number
        default: 48

env:
  PROJECT_ID: medscanai-476500
  SERVICE_NAME: vision-inference-api
  # Threshold: if we get more than this many low-confidence predictions in 24h, trigger retraining alert
  LOW_CONF_THRESHOLD: ${{ github.event.inputs.threshold || 5 }}
  HOURS_LOOKBACK: ${{ github.event.inputs.hours_lookback || 24 }}

jobs:
  check-low-confidence-threshold:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.PROJECT_ID }}
      
      - name: Query low confidence predictions
        id: check_metrics
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Checking Low Confidence Predictions"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "Project: $PROJECT_ID"
          echo "Service: $SERVICE_NAME"
          echo "Threshold: $LOW_CONF_THRESHOLD predictions in ${HOURS_LOOKBACK}h"
          echo ""
          
          # Calculate timestamps
          END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          START_TIME=$(date -u -d "${HOURS_LOOKBACK} hours ago" +"%Y-%m-%dT%H:%M:%SZ")
          
          echo "Time range: $START_TIME to $END_TIME"
          echo ""
          
          # Query the low_confidence_predictions metric
          # Note: The metric might not exist if it hasn't been created yet
          echo "Querying low confidence predictions metric..."
          
          # First check if the metric exists
          METRIC_EXISTS=false
          if gcloud logging metrics describe low_confidence_predictions --project=$PROJECT_ID &>/dev/null; then
            echo "‚úì Metric 'low_confidence_predictions' exists"
            METRIC_EXISTS=true
          else
            echo "‚ö†Ô∏è  Metric 'low_confidence_predictions' does not exist"
          fi
          
          # Always use direct log query as primary method (more reliable)
          echo ""
          echo "Querying Cloud Logging for [low_confidence] entries..."
          
          # Query logs directly for [low_confidence] entries
          LOG_FILTER='resource.type="cloud_run_revision"
            resource.labels.service_name="'$SERVICE_NAME'"
            textPayload:"[low_confidence]"
            timestamp>="'$START_TIME'"
            timestamp<="'$END_TIME'"'
          
          echo "Filter: $LOG_FILTER"
          echo ""
          
          # Count log entries
          LOW_CONF_COUNT=$(gcloud logging read "$LOG_FILTER" \
            --project=$PROJECT_ID \
            --limit=10000 \
            --format="value(timestamp)" 2>/dev/null | wc -l)
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Results:"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Low confidence predictions in last ${HOURS_LOOKBACK}h: $LOW_CONF_COUNT"
          echo "Threshold: $LOW_CONF_THRESHOLD"
          echo "Metric exists in monitoring: $METRIC_EXISTS"
          echo ""
          
          if [ $LOW_CONF_COUNT -ge $LOW_CONF_THRESHOLD ]; then
            echo "‚ö†Ô∏è  THRESHOLD EXCEEDED! Retraining recommended."
            echo "threshold_exceeded=true" >> $GITHUB_OUTPUT
            echo "low_conf_count=$LOW_CONF_COUNT" >> $GITHUB_OUTPUT
          else
            echo "‚úì Threshold not exceeded. No retraining needed."
            echo "threshold_exceeded=false" >> $GITHUB_OUTPUT
            echo "low_conf_count=$LOW_CONF_COUNT" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      
      - name: Send retraining notification email
        if: steps.check_metrics.outputs.threshold_exceeded == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üîÑ Vision Model Retraining Recommended - Low Confidence Threshold Exceeded"
          to: sriharsha.py@gmail.com,harshitha8.shekar@gmail.com,saumya08gupta@gmail.com,skothari855@gmail.com
          from: MedScan AI <${{ secrets.SMTP_USER }}>
          body: |
            Vision Inference Model Retraining Alert
            ========================================
            
            The low confidence prediction threshold has been exceeded and model retraining is recommended.
            
            Details:
            --------
            ‚Ä¢ Service: ${{ env.SERVICE_NAME }}
            ‚Ä¢ Time Period: Last ${{ env.HOURS_LOOKBACK }} hours
            ‚Ä¢ Low Confidence Predictions: ${{ steps.check_metrics.outputs.low_conf_count }}
            ‚Ä¢ Threshold: ${{ env.LOW_CONF_THRESHOLD }}
            ‚Ä¢ Status: ‚ö†Ô∏è  THRESHOLD EXCEEDED
            
            Next Steps:
            -----------
            1. Review recent predictions in Cloud Logging:
               https://console.cloud.google.com/logs/query;query=resource.type%3D%22cloud_run_revision%22%0Aresource.labels.service_name%3D%22vision-inference-api%22%0AtextPayload%3A%22%5Blow_confidence%5D%22?project=${{ env.PROJECT_ID }}
            
            2. Check the monitoring dashboard:
               https://console.cloud.google.com/monitoring/dashboards?project=${{ env.PROJECT_ID }}
            
            3. Consider retraining the vision models:
               ‚Ä¢ TB Detection Model
               ‚Ä¢ Lung Cancer Detection Model
            
            4. Trigger retraining workflow (if available):
               https://github.com/${{ github.repository }}/actions/workflows/vision-training.yaml
            
            Time: ${{ github.event.repository.updated_at }}
            Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            This is an automated notification from MedScan AI Vision Inference Monitoring.
      
      - name: Send error notification
        if: steps.check_metrics.outputs.threshold_exceeded == 'error'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚ùå Vision Model Monitoring - Error Checking Metrics"
          to: sriharsha.py@gmail.com
          from: MedScan AI <${{ secrets.SMTP_USER }}>
          body: |
            Vision Inference Model Monitoring Error
            ========================================
            
            An error occurred while checking the low confidence prediction metrics.
            
            Details:
            --------
            ‚Ä¢ Service: ${{ env.SERVICE_NAME }}
            ‚Ä¢ Error: Failed to query monitoring metrics
            
            Please check:
            1. The low_confidence_predictions metric exists
            2. Proper IAM permissions are set
            3. Cloud Logging is working correctly
            
            Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            This is an automated notification from MedScan AI Vision Inference Monitoring.
      
      - name: Summary
        if: always()
        run: |
          echo "## Vision Inference Retraining Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time Period:** Last $HOURS_LOOKBACK hours" >> $GITHUB_STEP_SUMMARY
          echo "- **Low Confidence Count:** ${{ steps.check_metrics.outputs.low_conf_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Threshold:** $LOW_CONF_THRESHOLD" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ steps.check_metrics.outputs.threshold_exceeded }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_metrics.outputs.threshold_exceeded }}" == "true" ]; then
            echo "‚ö†Ô∏è **Action Required:** Retraining recommended" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check_metrics.outputs.threshold_exceeded }}" == "false" ]; then
            echo "‚úÖ **No Action Required:** Threshold not exceeded" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Error:** Failed to check metrics" >> $GITHUB_STEP_SUMMARY
          fi

